# 背包 DP

背包系问题。

需要注意到时空复杂度与重量、权值的范围相关。

## 0-1 背包

模型：$n$ 件物品，每件物品最多选一个；在集合中选出一个符合某种限制条件的子集。

由于每种物品的数量限制，只能依次考虑每个物品是否选取。

### 洛谷 P1049 装箱问题

!!! 题意

    给定 $n$ 个数 $a_i$，求子集和不超过 $m$ 时的最大可能值。

可行性问题。

状态：$(i, x)$，前 $i$ 种数的子集和为 $x$。

转移：

- 每种元素只有选和不选。
- $(i, x) \to (i + 1, x)$
- $(i, x) \to (i + 1, x + a_{i + 1})$

拓扑序：$i$ 从 $1$ 到 $n$。

使用状态图遍历或递推。初始状态为 $(0, 0)$，找到可行状态 $(n, x)$ 的最大的 $x$。

空间复杂度：状态空间 $O(nm)$。

时间复杂度：每个状态转移两次，总时间 $O(nm)$。

### 洛谷 P1164 小 A 点菜

!!! 题意

    给定 $n$ 个数，求有多少个子集和为 $m$。数值相同但下标不同的元素视为不同的元素。

方案数问题。使用递推求方案数即可。

令 $dp_{i, j}$ 表示前 $i$ 种数子集和为 $j$ 时的方案数。显然有 $dp_{i, j} = dp_{i - 1, j} + dp_{i - 1, j - 1}$。

注意下标越界。

时空复杂度均为 $O(nm)$。

（在选取元素的顺序有影响的情况下，方案数是多少？）

### 洛谷 P1466 子集和

!!! 题意

    将 $1 \sim n$ 划分两个子集，且子集和相同，求方案数。

### 洛谷 P1048 采药

!!! 题意

    给定 $n$ 个物品，每个物品有重量 $w$ 和价值 $v$，求总重量 $\le m$ 的子集的最大价值和。重量小，价值大。

最优性问题。

状态：$(i, sumw, sumv)$，前 $i$ 个物品重量为 $sumw$ 时的最大价值 $sumv$。

转移：

- 每种物品选或不选。
- $(i, sumw, sumv) \to (i + 1, sumw + w_{i + 1}, sumv + v_{i + 1})$
- $(i, sumw, sumv) \to (i + 1, sumw, sumv)$

最优化属性：$sumv$。按 $(i, sumw)$ 分组后（对于同一组 $(i, sumw)$），每组只保留最大的 $sumv$。

分组拓扑序：$i$ 从 $1$ 到 $n$。

最优子结构：当前最优状态由之前的最优状态转移而来。

使用 DP 进行求解。令 $dp_{i, j}$ 表示前 $i$ 个物品重量为 $j$ 时的最大价值。显然有 $dp_{i, j} = \max \{ dp_{i - 1, j}, dp_{i - 1, j - w[i]} + v[i] \}$。

初始化有两种：

1. $dp_{0, 0}$ 为 $0$，其他所有状态为负无穷大。此时 $dp_{i, j}$ 表示的是总重量恰好为 $j$ 的最大价值。
2. 全部初始化为 $0$，此时 $dp_{i, j}$ 表示的是总重量 $\le j$ 的最大价值。

时空复杂度均为 $O(nm)$。

### at_dp_e

!!! 题意

    给定 $n$ 个物品，每个物品有重量 $w$ 和价值 $v$，求总重量 $\le m$ 的子集的最大价值和。重量大，价值小。

需要观察到，重量大，价值小。对最优化属性进行调整。

最优化属性：$sumw$。按 $(i, sumv)$ 分组后（对于同一组 $(i, sumv)$），每组只保留最小的 $sumw$（价值一定时，重量越小越好）。

令 $dp_{i, j}$ 表示前 $i$ 个物品价值为 $j$ 时的最小重量。显然有转移 $dp_{i, j} = \min \{ dp_{i - 1, j}, dp_{i - 1, j - v[i]} + w[i] \}$。

DP 处理之后，找到使得 $dp_{n, v} \le m$ 的最大的 $v$ 即可。

时空复杂度均为 $O(n \sum v)$

## 多重背包

模型：$n$ 件物品，每件物品最多选 $a_i$ 个；在可重集合中选出一个符合某种限制条件的子集。

由于每种物品的数量限制，只能依次考虑每个物品的选取数量。

### 洛谷 P1077 摆花

!!! 题意

    有 $n$ 种花，每种有 $a_i$ 盆，按照种类编号递增的方式摆 $m$ 盆花，求方案数。

方案数问题。

状态：$(i, x)$，前 $i$ 种花摆了 $x$ 盆。

转移：

- 枚举每种花摆几盆。
- $(i, x) \to (i + 1, x + k)$，其中 $0 \le k \le a_{i + 1}$。

拓扑序：$i$ 从 $1$ 到 $n$。

使用递推求解。令 $dp_{i, j}$ 表示前 $i$ 种花摆 $j$ 盆的方案数。初始状态 $dp_{0, 0}$ 为 $1$。可以写出如下转移代码。

```cpp
dp[0][0] = 1;
for (int i = 1; i <= n; i++) {  // 拓扑序
    for (int j = 0; j <= m; j++) {  // 状态
        for (int k = 0; k <= min(a[i], j); k++) {
            dp[i][j] += dp[i - 1][j - k];
        }
    }
}
```

（给出代码的目的是为了分析时间复杂度。）

空间复杂度：状态空间 $O(nm)$。

时间复杂度：看上去是 $O(n \times m \times a_i)$，但实际上是 $k$ 循环的总执行次数为 $O(\sum a_i \times m)$，因此总时间为 $O((n + \sum a_i) \times m)$。

（若不按照顺序递增，如何求方案数？）

### 洛谷 P2347 砝码称重

!!! 题意

    给定砝码重量和数量，判定可以构造出多少种重量。

可行性问题。递推或者状态图遍历。

### 洛谷 P1776 宝物筛选 / 洛谷 P1782 旅行商的背包

二进制优化 / 单调队列优化。

!!! 题意

    给定 $n$ 种物品，每种物品的重量、价值、数量为 $w_i, v_i, m_i$。选取一些物品，求总重量 $\le W$ 时的最大总价值。

状态：$(i, j, k)$，前 $i$ 种物品，总重量为 $j$，总价值为 $k$。

转移：

- 枚举每种物品选几个。
- $(i, j, k) \to (i + 1, j + c \times w_{i + 1}, k + c \times v_{i + 1})$，其中 $0 \le c \le m_i$。

最优化属性：$k$。对于同一组 $(i, j)$，$j$ 越大越好。

分组拓扑序：$i$ 从 $1$ 到 $n$。

显然具有最优子结构性质。

令 $dp_{i, j}$ 表示前 $i$ 种物品总重量为 $j$ 时的最大总价值。显然有转移 $dp_{i, j} = \max \{ dp_{i - 1}[j - c \times w_i] + c \times v_i \}$。

```cpp

```

时间复杂度超时。

#### 二进制拆分

令某种物品有 $x$ 件，你可以将 $x$ 件分为以下几件物品：

- 将 $2^0$ 个该种物品视为一件。
- 将 $2^1$ 个该种物品视为一件。
- $\dots$
- 将 $2^{k - 1}$ 个该种物品视为一件。
- 将 $x - (2^k - 1)$ 个该种物品视为一件。

可以证明，序列 $2^0, 2^1, \dots, 2^{k - 1}, x - (2^k - 1)$ 的子集和可以构造出 $0 \sim x$ 中的任意一个整数，且无法构造出大于 $x$ 的整数。

因此我们可以 $n$ 种物品的数量 $m_i$ 拆分为 $\log m_i$ 件物品后，转化为 01 背包进行求解。

```cpp

```

令 $V = 10^5$。

空间复杂度：重新拆分后的物品数量 $O(n \log V)$，状态空间 $O(N \log V \times W)$。

时间复杂度：$O(N \log V \times M)$。

## 完全背包

模型：$n$ 件物品，每件物品有无限个；在可重集合中选出一个符合某种限制条件的子集。

注意到每种物品有无限个，可以有两种思考方式：

1. 依次考虑每种物品的选取数量
2. 直接对数值进行构造。

### 逐月 P1387

!!! 题意

    有一个点数为 $1 \sim 6$ 的骰子。可以投掷无限次。求每次掷骰子的点数之和为 $n$ 的方案数。

只能使用数值状态。

状态：$(x)$，点数为 $x$。

转移：$(x) \to (x + k)$，其中 $1 \le k \le 6$。

拓扑序：$x$ 从小到大。

递推求解。

空间复杂度：状态空间 $O(n)$。

时间复杂度：每个状态转移 $6$ 次，总时间 $O(n)$。

### 逐月 P1389 / 洛谷 P2840

!!! 题意

    给定 $n$ 种货币的面值 $a_i$，每种货币无限个。求构造总面值 $m$ 的方法数。$1 + 2$ 和 $2 + 1$ 视作为不同方案。

只能使用数值状态。

状态：$(x)$，面值为 $x$。

转移：$(x) \to (x + a_i)$。

拓扑序：$x$ 从小到大。

递推求解。

空间复杂度：状态空间 $O(m)$。

时间复杂度：每个状态转移 $n$ 次，总时间 $O(nm)$。

### 逐月 P1390 / 洛谷 P2834

!!! 题意

    给定 $n$ 种货币的面值，每种货币无限个。求构造总面值 $m$ 的方法数。$1 + 2$ 和 $2 + 1$ 视作为相同方案。

必须按顺序考虑每种货币的选取数量。

状态：$(i, x)$，前 $i$ 种货币构造面值 $x$。

转移：

- 考虑选还是不选，注意选了之后还可以继续选。
- $(i, x) \to (i, x + a_i)$
- $(i, x) \to (i + 1, x)$

拓扑序：$i$ 从小到大；当 $i$ 相同时，$x$ 从小到大。

递推求解。

空间复杂度：状态空间 $O(nm)$。

时间复杂度：每个状态转移 $2$ 次，总时间 $O(nm)$。

### 逐月 P1388 / 洛谷 P2842

!!! 题意

    给定 $n$ 种货币的面值，每种货币无限个。求构造总面值 $m$ 的最少货币数量。

既可以使用数值作为状态，也可以按顺序考虑每种货币的选取数量

- 最少数量与面值的构造顺序无关

为了方便实现，采取数值作为状态。

状态：$(x, c)$ 用 $c$ 张货币构造面值 $x$。

转移：$(x, c) \to (x + a_i, c + 1)$。

最优化属性：$c$；对于同一组 $(x)$，$c$ 越小越好。

分组拓扑序：$x$ 从小到大。

显然有最优子结构性质。

令 $dp_x$ 表示构造面值 $x$ 的最少张数，显然有转移 $dp_x = \min \{ dp_{x - a_i} \} + 1$。

空间复杂度：状态空间 $O(m)$。

时间复杂度：每个状态转移 $n$ 次，总时间 $O(nm)$。

### 洛谷 P1616 疯狂的采药

!!! 题意

    给定 $n$ 种草药的采取时间 $t_i$ 和价值 $v_i$，每种草药无限个。在时间 $T$ 以内采药的最大价值。

（思路同上一题，让学生自己推状态、转移、最优化属性、拓扑序）。

## 优化

### 滚动数组空间优化

### 降维空间优化

### 前缀优化

## 其他

洛谷 P1757 分组背包

洛谷 P2725 邮票 多种方法

洛谷 P6567 买表

洛谷 P5020 货币系统 可行性

abc321_f

at_dp_x

at_dp_m

### 洛谷 P6771 太空电梯

!!! 题意

    有 $n$ 种方块，每种方块有高度 $h_i$ 和数量 $c_i$，选方块叠塔，第 $i$ 种方块在塔中的任意部分不能超过 $a_i$。有塔的最大高度。

最优性问题。可以观察到，任意一种合法的叠塔方案，总是可以调整一些方块的顺序，使得塔中的方块从下至上是按 $a_i$ 递增的。

首先将每种方块按 $a_i$ 排序，然后依次考虑每种方块的选取数量。

状态：$(i, j, k)$，前 $i$ 种方块，塔高度为 $j$，